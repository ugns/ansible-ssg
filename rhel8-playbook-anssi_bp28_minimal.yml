---
###############################################################################
#
# Ansible remediation role for profile anssi_bp28_minimal
# Profile Title:  ANSSI-BP-028 (minimal)
# Profile Description:
# This profile contains configurations that align to ANSSI-BP-028 v1.2 at the minimal hardening level.
#
# ANSSI is the French National Information Security Agency, and stands for Agence nationale de la sécurité des systèmes d'information.
# ANSSI-BP-028 is a configuration recommendation for GNU/Linux systems.
#
# A copy of the ANSSI-BP-028 can be found at the ANSSI website:
# https://www.ssi.gouv.fr/administration/guide/recommandations-de-securite-relatives-a-un-systeme-gnulinux/
#
# Benchmark ID:  RHEL-8
# Benchmark Version:  0.1.61
#
# XCCDF Version:  1.1
#
# This file was generated by OpenSCAP 1.2.16 using:
# 	$ oscap xccdf generate fix --profile anssi_bp28_minimal --template urn:xccdf:fix:script:ansible sds.xml
#
# This script is generated from an OpenSCAP profile without preliminary evaluation.
# It attempts to fix every selected rule, even if the system is already compliant.
#
# How to apply this remediation role:
# $ ansible-playbook -i "192.168.1.155," playbook.yml
# $ ansible-playbook -i inventory.ini playbook.yml
#
###############################################################################

 - hosts: all
   pre_tasks:
     - name: Verify Ansible meets SCAP-Security-Guide version requirements.
       assert:
         that: "ansible_version.full is version_compare('2.5', '>=')"
         msg: >
           "You must update Ansible to at least version 2.5 to use this role."

   vars:
      var_password_pam_unix_remember: !!str 2
      var_accounts_passwords_pam_faillock_deny: !!str 3
      var_accounts_passwords_pam_faillock_fail_interval: !!str 900
      var_accounts_passwords_pam_faillock_unlock_time: !!str 900
      var_password_pam_dcredit: !!str -1
      var_password_pam_lcredit: !!str -1
      var_password_pam_minlen: !!str 18
      var_password_pam_ocredit: !!str -1
      var_password_pam_ucredit: !!str -1
      var_accounts_maximum_age_login_defs: !!str 90
      var_accounts_password_minlen_login_defs: !!str 18
      var_password_pam_unix_rounds: !!str 65536
      var_password_pam_unix_rounds: !!str 65536
   tasks:
    - name: Find /etc/sudoers.d/ files
      find:
        paths:
          - /etc/sudoers.d/
      register: sudoers
      tags:
        - CCE-82202-3
        - DISA-STIG-RHEL-08-010381
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_no_authenticate

    - name: Remove lines containing !authenticate from sudoers files
      replace:
        regexp: (^(?!#).*[\s]+\!authenticate.*$)
        replace: '# \g<1>'
        path: '{{ item.path }}'
        validate: /usr/sbin/visudo -cf %s
      with_items:
        - path: /etc/sudoers
        - '{{ sudoers.files }}'
      tags:
        - CCE-82202-3
        - DISA-STIG-RHEL-08-010381
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_no_authenticate

    - name: Find /etc/sudoers.d/ files
      find:
        paths:
          - /etc/sudoers.d/
      register: sudoers
      tags:
        - CCE-82197-5
        - DISA-STIG-RHEL-08-010380
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_nopasswd

    - name: Remove lines containing NOPASSWD from sudoers files
      replace:
        regexp: (^(?!#).*[\s]+NOPASSWD[\s]*\:.*$)
        replace: '# \g<1>'
        path: '{{ item.path }}'
        validate: /usr/sbin/visudo -cf %s
      with_items:
        - path: /etc/sudoers
        - '{{ sudoers.files }}'
      tags:
        - CCE-82197-5
        - DISA-STIG-RHEL-08-010380
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-11
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy
        - sudo_remove_nopasswd

    - name: Ensure dnf-automatic is installed
      package:
        name: dnf-automatic
        state: present
      tags:
        - CCE-82985-3
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_dnf-automatic_installed

    - name: Configure dnf-automatic to Install Available Updates Automatically
      ini_file:
        dest: /etc/dnf/automatic.conf
        section: commands
        option: apply_updates
        value: 'yes'
        create: true
      tags:
        - CCE-82494-6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(5)
        - NIST-800-53-SI-2(c)
        - dnf-automatic_apply_updates
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed
        - unknown_strategy

    - name: Configure dnf-automatic to Install Only Security Updates
      ini_file:
        dest: /etc/dnf/automatic.conf
        section: commands
        option: upgrade_type
        value: security
        create: true
      tags:
        - CCE-82267-6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(5)
        - NIST-800-53-SI-2(c)
        - dnf-automatic_security_updates_only
        - low_complexity
        - low_severity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80790-9
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-08-010370
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - configure_strategy
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed

    - name: Ensure GPG check is globally activated
      ini_file:
        dest: /etc/yum.conf
        section: main
        option: gpgcheck
        value: 1
        no_extra_spaces: true
        create: false
      when: '"yum" in ansible_facts.packages'
      tags:
        - CCE-80790-9
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-08-010370
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - configure_strategy
        - ensure_gpgcheck_globally_activated
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80791-7
        - DISA-STIG-RHEL-08-010371
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy

    - name: Ensure GPG check Enabled for Local Packages (Yum)
      ini_file:
        dest: /etc/yum.conf
        section: main
        option: localpkg_gpgcheck
        value: 1
        no_extra_spaces: true
        create: true
      when: '"yum" in ansible_facts.packages'
      tags:
        - CCE-80791-7
        - DISA-STIG-RHEL-08-010371
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - ensure_gpgcheck_local_packages
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed
        - unknown_strategy

    - name: Grep for yum repo section names
      shell: |
        set -o pipefail
        grep -HEr '^\[.+\]' -r /etc/yum.repos.d/
      register: repo_grep_results
      ignore_errors: true
      changed_when: false
      tags:
        - CCE-80792-5
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - enable_strategy
        - ensure_gpgcheck_never_disabled
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed

    - name: Set gpgcheck=1 for each yum repo
      ini_file:
        path: '{{ item[0] }}'
        section: '{{ item[1] }}'
        option: gpgcheck
        value: '1'
        no_extra_spaces: true
      loop: '{{ repo_grep_results.stdout | regex_findall( ''(.+\.repo):\[(.+)\]\n?'' )
        }}'
      tags:
        - CCE-80792-5
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-11(a)
        - NIST-800-53-CM-11(b)
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SA-12
        - NIST-800-53-SA-12(10)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - enable_strategy
        - ensure_gpgcheck_never_disabled
        - high_severity
        - low_complexity
        - medium_disruption
        - no_reboot_needed

    - name: Read permission of GPG key directory
      stat:
        path: /etc/pki/rpm-gpg/
      register: gpg_key_directory_permission
      check_mode: false
      tags:
        - CCE-80795-8
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_redhat_gpgkey_installed
        - high_severity
        - medium_complexity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy

    - name: Read signatures in GPG key
      command: gpg --show-keys --with-fingerprint --with-colons "/etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release"
      args:
        warn: false
      changed_when: false
      register: gpg_fingerprints
      check_mode: false
      tags:
        - CCE-80795-8
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_redhat_gpgkey_installed
        - high_severity
        - medium_complexity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy

    - name: Set Fact - Installed GPG Fingerprints
      set_fact:
        gpg_installed_fingerprints: |-
          {{ gpg_fingerprints.stdout | regex_findall('^pub.*
          (?:^fpr[:]*)([0-9A-Fa-f]*)', '\1') | list }}
      tags:
        - CCE-80795-8
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_redhat_gpgkey_installed
        - high_severity
        - medium_complexity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy

    - name: Set Fact - Valid fingerprints
      set_fact:
        gpg_valid_fingerprints: ("567E347AD0044ADE55BA8A5F199E2F91FD431D51" "6A6AA7C97C8890AEC6AEBFE2F76F66C3D4082792")
      tags:
        - CCE-80795-8
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_redhat_gpgkey_installed
        - high_severity
        - medium_complexity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy

    - name: Import RedHat GPG key
      rpm_key:
        state: present
        key: /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
      when:
        - gpg_key_directory_permission.stat.mode <= '0755'
        - (gpg_installed_fingerprints | difference(gpg_valid_fingerprints)) | length ==
          0
        - gpg_installed_fingerprints | length > 0
        - ansible_distribution == "RedHat"
      tags:
        - CCE-80795-8
        - CJIS-5.10.4.1
        - NIST-800-171-3.4.8
        - NIST-800-53-CM-5(3)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SC-12
        - NIST-800-53-SC-12(3)
        - NIST-800-53-SI-7
        - PCI-DSS-Req-6.2
        - ensure_redhat_gpgkey_installed
        - high_severity
        - medium_complexity
        - medium_disruption
        - no_reboot_needed
        - restrict_strategy

    - name: Security patches are up to date
      package:
        name: '*'
        state: latest
      tags:
        - CCE-80865-9
        - CJIS-5.10.4.1
        - DISA-STIG-RHEL-08-010010
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(5)
        - NIST-800-53-SI-2(c)
        - PCI-DSS-Req-6.2
        - high_disruption
        - high_severity
        - low_complexity
        - patch_strategy
        - reboot_required
        - security_patches_up_to_date
        - skip_ansible_lint

    - name: Enable timer dnf-automatic
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Enable timer dnf-automatic
          systemd:
            name: dnf-automatic.timer
            enabled: 'yes'
            state: started
          when:
            - '"dnf-automatic" in ansible_facts.packages'
      tags:
        - CCE-82360-9
        - NIST-800-53-CM-6(a)
        - NIST-800-53-SI-2(5)
        - NIST-800-53-SI-2(c)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - timer_dnf-automatic_enabled

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check the integrity of the current authselect profile
      ansible.builtin.command:
        cmd: authselect check
      register: result_authselect_check_cmd
      changed_when: false
      ignore_errors: true
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Informative message based on the authselect integrity check result
      ansible.builtin.assert:
        that:
          - result_authselect_check_cmd is success
        fail_msg:
          - authselect integrity check failed. Remediation aborted!
          - This remediation could not be applied because the authselect profile is not
            intact.
          - It is not recommended to manually edit the PAM files when authselect is available
          - In cases where the default authselect profile does not cover a specific demand,
            a custom authselect profile is recommended.
        success_msg:
          - authselect integrity check passed
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Get authselect current profile
      ansible.builtin.shell:
        cmd: authselect current -r | awk '{ print $1 }'
      register: result_authselect_profile
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Define the current authselect profile as a local fact
      ansible.builtin.set_fact:
        authselect_current_profile: '{{ result_authselect_profile.stdout }}'
        authselect_custom_profile: '{{ result_authselect_profile.stdout }}'
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - result_authselect_profile.stdout is match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Define the new authselect custom profile as a local fact
      ansible.builtin.set_fact:
        authselect_current_profile: '{{ result_authselect_profile.stdout }}'
        authselect_custom_profile: custom/hardening
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - result_authselect_profile.stdout is not match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Get authselect current features to also enable them in the custom profile
      ansible.builtin.shell:
        cmd: authselect current | tail -n+3 | awk '{ print $2 }'
      register: result_authselect_features
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - authselect_current_profile is not match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check if any custom profile with the same name was already created in the
        past
      ansible.builtin.stat:
        path: /etc/authselect/{{ authselect_custom_profile }}
      register: result_authselect_custom_profile_present
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
        - authselect_current_profile is not match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Create a custom profile based on the current profile
      ansible.builtin.command:
        cmd: authselect create-profile hardening -b sssd
      register: result_authselect_create_profile
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
        - authselect_current_profile is not match("custom/")
        - not result_authselect_custom_profile_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure the desired configuration is updated in the custom profile
      ansible.builtin.replace:
        dest: '{{ item }}'
        regexp: (.*pam_pwhistory.so.*remember=)(\S+)(.*)$
        replace: \g<1>{{ var_password_pam_unix_remember }}\g<3>
      loop:
        - /etc/authselect/{{ authselect_custom_profile }}/system-auth
        - /etc/authselect/{{ authselect_custom_profile }}/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - authselect_custom_profile is match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure the desired configuration in present in the custom profile
      ansible.builtin.lineinfile:
        dest: '{{ item }}'
        insertafter: ^password.*requisite.*pam_pwquality.so.*
        line: password    requisite     pam_pwhistory.so remember={{ var_password_pam_unix_remember
          }} use_authtok
      loop:
        - /etc/authselect/{{ authselect_custom_profile }}/system-auth
        - /etc/authselect/{{ authselect_custom_profile }}/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - authselect_custom_profile is match("custom/")
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure a backup of current authselect profile before select the custom profile
      ansible.builtin.command:
        cmd: authselect apply-changes -b --backup=before-pwhistory-hardening.backup
      register: result_authselect_backup
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_check_cmd is success
        - result_authselect_profile is not skipped
        - authselect_current_profile is not match("custom/")
        - authselect_custom_profile is not match(authselect_current_profile)
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure the custom profile is selected
      ansible.builtin.command:
        cmd: authselect select {{ authselect_custom_profile }} --force
      register: result_pam_authselect_select_profile
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_check_cmd is success
        - result_authselect_profile is not skipped
        - authselect_current_profile is not match("custom/")
        - authselect_custom_profile is not match(authselect_current_profile)
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Restore the authselect features in the custom profile
      ansible.builtin.command:
        cmd: authselect enable-feature {{ item }}
      register: result_pam_authselect_select_features
      loop: '{{ result_authselect_features.stdout_lines }}'
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_profile is not skipped
        - result_authselect_features is not skipped
        - result_pam_authselect_select_profile is not skipped
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure the custom profile changes are applied
      ansible.builtin.command:
        cmd: authselect apply-changes -b --backup=after-pwhistory-hardening.backup
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_check_cmd is success
        - result_authselect_profile is not skipped
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Do not allow users to reuse recent passwords - system-auth (change)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^(password\s+sufficient\s+pam_unix\.so\s.*remember\s*=\s*)(\S+)(.*)$
        replace: \g<1>{{ var_password_pam_unix_remember }}\g<3>
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Do not allow users to reuse recent passwords - system-auth (add)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^password\s+sufficient\s+pam_unix\.so\s(?!.*remember\s*=\s*).*$
        replace: \g<0> remember={{ var_password_pam_unix_remember }}
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Do not allow users to reuse recent passwords - system-auth (change)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^(password\s+(?:(?:requisite)|(?:required))\s+pam_pwhistory\.so\s.*remember\s*=\s*)(\S+)(.*)$
        replace: \g<1>{{ var_password_pam_unix_remember }}\g<3>
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Do not allow users to reuse recent passwords - system-auth (add)
      replace:
        dest: /etc/pam.d/system-auth
        regexp: ^password\s+(?:(?:requisite)|(?:required))\s+pam_pwhistory\.so\s(?!.*remember\s*=\s*).*$
        replace: \g<0> remember={{ var_password_pam_unix_remember }}
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-80666-1
        - CJIS-5.6.2.1.1
        - NIST-800-171-3.5.8
        - NIST-800-53-IA-5(1)(e)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.5
        - accounts_password_pam_unix_remember
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authconfig
      ansible.builtin.stat:
        path: /usr/sbin/authconfig
      register: result_authconfig_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure pam_faillock.so is properly enabled using authconfig tool
      ansible.builtin.command:
        cmd: authconfig --enablefaillock --update
      when:
        - '"pam" in ansible_facts.packages'
        - result_authconfig_check.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authconfig_check.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check integrity of authselect current profile
      ansible.builtin.command:
        cmd: authselect check
      register: result_authselect_check_cmd
      changed_when: false
      ignore_errors: true
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Informative message based on the authselect integrity check result
      ansible.builtin.assert:
        that:
          - result_authselect_check_cmd is success
        fail_msg:
          - authselect integrity check failed. Remediation aborted!
          - This remediation could not be applied because the authselect profile is not
            intact.
          - It is not recommended to manually edit the PAM files when authselect is available
          - In cases where the default authselect profile does not cover a specific demand,
            a custom authselect profile is recommended.
        success_msg:
          - authselect integrity check passed
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Get authselect current features
      ansible.builtin.shell:
        cmd: authselect current | tail -n+3 | awk '{ print $2 }'
      register: result_authselect_features
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure with-faillock feature is enabled via authselect tool
      ansible.builtin.command:
        cmd: authselect enable-feature with-faillock
      register: result_authselect_cmd
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
        - result_authselect_features.stdout is not search("with-faillock")
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check the presence of /etc/security/faillock.conf file
      ansible.builtin.stat:
        path: /etc/security/faillock.conf
      register: result_faillock_conf_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so deny parameter in /etc/security/faillock.conf
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: ^\s*deny\s*=
        line: deny = {{ var_accounts_passwords_pam_faillock_deny }}
        state: present
      when:
        - '"pam" in ansible_facts.packages'
        - result_faillock_conf_check.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so preauth deny parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so preauth.*)(deny)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_deny }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so authfail deny parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so authfail.*)(deny)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_deny }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80667-9
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020010
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.6
        - accounts_passwords_pam_faillock_deny
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authconfig
      ansible.builtin.stat:
        path: /usr/sbin/authconfig
      register: result_authconfig_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure pam_faillock.so is properly enabled using authconfig tool
      ansible.builtin.command:
        cmd: authconfig --enablefaillock --update
      when:
        - '"pam" in ansible_facts.packages'
        - result_authconfig_check.stat.exists
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authconfig_check.stat.exists
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check integrity of authselect current profile
      ansible.builtin.command:
        cmd: authselect check
      register: result_authselect_check_cmd
      changed_when: false
      ignore_errors: true
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Informative message based on the authselect integrity check result
      ansible.builtin.assert:
        that:
          - result_authselect_check_cmd is success
        fail_msg:
          - authselect integrity check failed. Remediation aborted!
          - This remediation could not be applied because the authselect profile is not
            intact.
          - It is not recommended to manually edit the PAM files when authselect is available
          - In cases where the default authselect profile does not cover a specific demand,
            a custom authselect profile is recommended.
        success_msg:
          - authselect integrity check passed
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Get authselect current features
      ansible.builtin.shell:
        cmd: authselect current | tail -n+3 | awk '{ print $2 }'
      register: result_authselect_features
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure with-faillock feature is enabled via authselect tool
      ansible.builtin.command:
        cmd: authselect enable-feature with-faillock
      register: result_authselect_cmd
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
        - result_authselect_features.stdout is not search("with-faillock")
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check the presence of /etc/security/faillock.conf file
      ansible.builtin.stat:
        path: /etc/security/faillock.conf
      register: result_faillock_conf_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so even_deny_root parameter in /etc/security/faillock.conf
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: ^\s*even_deny_root
        line: even_deny_root
        state: present
      when:
        - '"pam" in ansible_facts.packages'
        - result_faillock_conf_check.stat.exists
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if pam_faillock.so even_deny_root parameter is already enabled in pam
        files
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        regexp: .*auth.*pam_faillock.so (preauth|authfail).*even_deny_root
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_faillock_even_deny_root
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so preauth even_deny_root parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so preauth.*)
        line: \1required\3 even_deny_root
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_even_deny_root.found == 0
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so authfail even_deny_root parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so authfail.*)
        line: \1required\3 even_deny_root
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_even_deny_root.found == 0
      tags:
        - CCE-80668-7
        - DISA-STIG-RHEL-08-020022
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(c)
        - accounts_passwords_pam_faillock_deny_root
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authconfig
      ansible.builtin.stat:
        path: /usr/sbin/authconfig
      register: result_authconfig_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure pam_faillock.so is properly enabled using authconfig tool
      ansible.builtin.command:
        cmd: authconfig --enablefaillock --update
      when:
        - '"pam" in ansible_facts.packages'
        - result_authconfig_check.stat.exists
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authconfig_check.stat.exists
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check integrity of authselect current profile
      ansible.builtin.command:
        cmd: authselect check
      register: result_authselect_check_cmd
      changed_when: false
      ignore_errors: true
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Informative message based on the authselect integrity check result
      ansible.builtin.assert:
        that:
          - result_authselect_check_cmd is success
        fail_msg:
          - authselect integrity check failed. Remediation aborted!
          - This remediation could not be applied because the authselect profile is not
            intact.
          - It is not recommended to manually edit the PAM files when authselect is available
          - In cases where the default authselect profile does not cover a specific demand,
            a custom authselect profile is recommended.
        success_msg:
          - authselect integrity check passed
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Get authselect current features
      ansible.builtin.shell:
        cmd: authselect current | tail -n+3 | awk '{ print $2 }'
      register: result_authselect_features
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure with-faillock feature is enabled via authselect tool
      ansible.builtin.command:
        cmd: authselect enable-feature with-faillock
      register: result_authselect_cmd
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
        - result_authselect_features.stdout is not search("with-faillock")
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check the presence of /etc/security/faillock.conf file
      ansible.builtin.stat:
        path: /etc/security/faillock.conf
      register: result_faillock_conf_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so fail_interval parameter in /etc/security/faillock.conf
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: ^\s*fail_interval\s*=
        line: fail_interval = {{ var_accounts_passwords_pam_faillock_fail_interval }}
        state: present
      when:
        - '"pam" in ansible_facts.packages'
        - result_faillock_conf_check.stat.exists
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if pam_faillock.so fail_interval parameter is already enabled in pam
        files
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        regexp: .*auth.*pam_faillock.so (preauth|authfail).*fail_interval
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_faillock_fail_interval
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the inclusion of pam_faillock.so preauth fail_interval parameter in
        auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so preauth.*)
        line: \1required\3 fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_fail_interval.found == 0
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the inclusion of pam_faillock.so authfail fail_interval parameter in
        auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so authfail.*)
        line: \1required\3 fail_interval={{ var_accounts_passwords_pam_faillock_fail_interval
          }}
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_fail_interval.found == 0
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the desired value for pam_faillock.so preauth fail_interval parameter
        in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so preauth.*)(fail_interval)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_fail_interval }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_fail_interval.found > 0
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the desired value for pam_faillock.so authfail fail_interval parameter
        in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so authfail.*)(fail_interval)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_fail_interval }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
        - result_pam_faillock_fail_interval.found > 0
      tags:
        - CCE-80669-5
        - DISA-STIG-RHEL-08-020012
        - NIST-800-53-AC-7(a)
        - NIST-800-53-CM-6(a)
        - accounts_passwords_pam_faillock_interval
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authconfig
      ansible.builtin.stat:
        path: /usr/sbin/authconfig
      register: result_authconfig_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure pam_faillock.so is properly enabled using authconfig tool
      ansible.builtin.command:
        cmd: authconfig --enablefaillock --update
      when:
        - '"pam" in ansible_facts.packages'
        - result_authconfig_check.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authconfig_check.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check integrity of authselect current profile
      ansible.builtin.command:
        cmd: authselect check
      register: result_authselect_check_cmd
      changed_when: false
      ignore_errors: true
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Informative message based on the authselect integrity check result
      ansible.builtin.assert:
        that:
          - result_authselect_check_cmd is success
        fail_msg:
          - authselect integrity check failed. Remediation aborted!
          - This remediation could not be applied because the authselect profile is not
            intact.
          - It is not recommended to manually edit the PAM files when authselect is available
          - In cases where the default authselect profile does not cover a specific demand,
            a custom authselect profile is recommended.
        success_msg:
          - authselect integrity check passed
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Get authselect current features
      ansible.builtin.shell:
        cmd: authselect current | tail -n+3 | awk '{ print $2 }'
      register: result_authselect_features
      changed_when: false
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure with-faillock feature is enabled via authselect tool
      ansible.builtin.command:
        cmd: authselect enable-feature with-faillock
      register: result_authselect_cmd
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present is not skipped
        - result_authselect_present.stat.exists
        - result_authselect_check_cmd is success
        - result_authselect_features.stdout is not search("with-faillock")
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Check the presence of /etc/security/faillock.conf file
      ansible.builtin.stat:
        path: /etc/security/faillock.conf
      register: result_faillock_conf_check
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so unlock_time parameter in /etc/security/faillock.conf
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: ^\s*unlock_time\s*=
        line: unlock_time = {{ var_accounts_passwords_pam_faillock_unlock_time }}
        state: present
      when:
        - '"pam" in ansible_facts.packages'
        - result_faillock_conf_check.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so preauth unlock_time parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so preauth.*)(unlock_time)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_unlock_time }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure the pam_faillock.so authfail unlock_time parameter in auth section
      ansible.builtin.lineinfile:
        path: '{{ item }}'
        backrefs: true
        regexp: (^\s*auth\s+)([\w\[].*\b)(\s+pam_faillock.so authfail.*)(unlock_time)=[0-5]+(.*)
        line: \1required\3\4={{ var_accounts_passwords_pam_faillock_unlock_time }}\5
        state: present
      loop:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
      when:
        - '"pam" in ansible_facts.packages'
        - not result_faillock_conf_check.stat.exists
      tags:
        - CCE-80670-3
        - CJIS-5.5.3
        - DISA-STIG-RHEL-08-020016
        - NIST-800-171-3.1.8
        - NIST-800-53-AC-7(b)
        - NIST-800-53-CM-6(a)
        - PCI-DSS-Req-8.1.7
        - accounts_passwords_pam_faillock_unlock_time
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80653-9
        - DISA-STIG-RHEL-08-020130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM variable dcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*dcredit
        line: dcredit = {{ var_password_pam_dcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80653-9
        - DISA-STIG-RHEL-08-020130
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_dcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80655-4
        - DISA-STIG-RHEL-08-020120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM variable lcredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*lcredit
        line: lcredit = {{ var_password_pam_lcredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80655-4
        - DISA-STIG-RHEL-08-020120
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_lcredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80656-2
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020230
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM variable minlen is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*minlen
        line: minlen = {{ var_password_pam_minlen }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80656-2
        - CJIS-5.6.2.1.1
        - DISA-STIG-RHEL-08-020230
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_minlen
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80663-8
        - DISA-STIG-RHEL-08-020280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM variable ocredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ocredit
        line: ocredit = {{ var_password_pam_ocredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80663-8
        - DISA-STIG-RHEL-08-020280
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - accounts_password_pam_ocredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80665-3
        - DISA-STIG-RHEL-08-020110
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Ensure PAM variable ucredit is set accordingly
      lineinfile:
        create: true
        dest: /etc/security/pwquality.conf
        regexp: ^#?\s*ucredit
        line: ucredit = {{ var_password_pam_ucredit }}
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-80665-3
        - DISA-STIG-RHEL-08-020110
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(4)
        - NIST-800-53-IA-5(c)
        - PCI-DSS-Req-8.2.3
        - accounts_password_pam_ucredit
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80647-1
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-08-020200
        - NIST-800-171-3.5.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.4
        - accounts_maximum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Set Password Maximum Age
      lineinfile:
        create: true
        dest: /etc/login.defs
        regexp: ^#?PASS_MAX_DAYS
        line: PASS_MAX_DAYS {{ var_accounts_maximum_age_login_defs }}
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-80647-1
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-08-020200
        - NIST-800-171-3.5.6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-53-IA-5(f)
        - PCI-DSS-Req-8.2.4
        - accounts_maximum_age_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80652-1
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-08-020231
        - NIST-800-171-3.5.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(f)
        - accounts_password_minlen_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Set Password Minimum Length in login.defs
      lineinfile:
        dest: /etc/login.defs
        regexp: ^PASS_MIN_LEN *[0-9]*
        state: present
        line: PASS_MIN_LEN        {{ var_accounts_password_minlen_login_defs }}
        create: true
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
        - CCE-80652-1
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-08-020231
        - NIST-800-171-3.5.7
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IA-5(1)(a)
        - NIST-800-53-IA-5(f)
        - accounts_password_minlen_login_defs
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83403-6
        - DISA-STIG-RHEL-08-010130
        - accounts_password_pam_unix_rounds_password_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check for existing rounds parameter
      ansible.builtin.lineinfile:
        path: /etc/pam.d/password-auth
        create: false
        regexp: ^password.*pam_unix.so.*rounds=
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_unix_rounds_present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83403-6
        - DISA-STIG-RHEL-08-010130
        - accounts_password_pam_unix_rounds_password_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83403-6
        - DISA-STIG-RHEL-08-010130
        - accounts_password_pam_unix_rounds_password_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Remediation where authselect tool is present
      block:

        - name: Check the integrity of the current authselect profile
          ansible.builtin.command:
            cmd: authselect check
          register: result_authselect_check_cmd
          changed_when: false
          ignore_errors: true

        - name: Informative message based on the authselect integrity check result
          ansible.builtin.assert:
            that:
              - result_authselect_check_cmd is success
            fail_msg:
              - authselect integrity check failed. Remediation aborted!
              - This remediation could not be applied because the authselect profile is
                not intact.
              - It is not recommended to manually edit the PAM files when authselect is
                available.
              - In cases where the default authselect profile does not cover a specific
                demand, a custom authselect profile is recommended.
            success_msg:
              - authselect integrity check passed

        - name: Get authselect current profile
          ansible.builtin.shell:
            cmd: authselect current -r | awk '{ print $1 }'
          register: result_authselect_profile
          changed_when: false
          when:
            - result_authselect_check_cmd is success

        - name: Define the current authselect profile as a local fact
          ansible.builtin.set_fact:
            authselect_current_profile: '{{ result_authselect_profile.stdout }}'
            authselect_custom_profile: '{{ result_authselect_profile.stdout }}'
          when:
            - result_authselect_profile is not skipped
            - result_authselect_profile.stdout is match("custom/")

        - name: Define the new authselect custom profile as a local fact
          ansible.builtin.set_fact:
            authselect_current_profile: '{{ result_authselect_profile.stdout }}'
            authselect_custom_profile: custom/hardening
          when:
            - result_authselect_profile is not skipped
            - result_authselect_profile.stdout is not match("custom/")

        - name: Get authselect current features to also enable them in the custom profile
          ansible.builtin.shell:
            cmd: authselect current | tail -n+3 | awk '{ print $2 }'
          register: result_authselect_features
          changed_when: false
          when:
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")

        - name: Check if any custom profile with the same name was already created in
            the past
          ansible.builtin.stat:
            path: /etc/authselect/{{ authselect_custom_profile }}
          register: result_authselect_custom_profile_present
          changed_when: false
          when:
            - authselect_current_profile is not match("custom/")

        - name: Create a custom profile based on the current profile
          ansible.builtin.command:
            cmd: authselect create-profile hardening -b sssd
          when:
            - result_authselect_check_cmd is success
            - authselect_current_profile is not match("custom/")
            - not result_authselect_custom_profile_present.stat.exists

        - name: Ensure the desired rounds value is updated in the custom profile
          ansible.builtin.replace:
            dest: /etc/authselect/{{ authselect_custom_profile }}/password-auth
            regexp: (^\s*password.*pam_unix.so.*rounds=)(\S+)(.*)$
            replace: \g<1>{{ var_password_pam_unix_rounds }}\g<3>
          when:
            - result_authselect_profile is not skipped
            - result_pam_unix_rounds_present.found == 1

        - name: Ensure the rounds parameter is included in the custom profile
          ansible.builtin.replace:
            dest: /etc/authselect/{{ authselect_custom_profile }}/password-auth
            regexp: (^\s*password.*pam_unix.so.*)(?! rounds=\S+)(.*)$
            replace: \g<1> \g<2> rounds={{ var_password_pam_unix_rounds }}
          when:
            - result_authselect_profile is not skipped
            - result_pam_unix_rounds_present.found == 0

        - name: Ensure a backup of current authselect profile before selecting the custom
            profile
          ansible.builtin.command:
            cmd: authselect apply-changes -b --backup=before-rounds-hardening.backup
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")
            - authselect_custom_profile is not match(authselect_current_profile)

        - name: Ensure the custom profile is selected
          ansible.builtin.command:
            cmd: authselect select {{ authselect_custom_profile }} --force
          register: result_pam_authselect_select_profile
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")
            - authselect_custom_profile is not match(authselect_current_profile)

        - name: Restore the authselect features in the custom profile
          ansible.builtin.command:
            cmd: authselect enable-feature {{ item }}
          loop: '{{ result_authselect_features.stdout_lines }}'
          when:
            - result_authselect_profile is not skipped
            - result_authselect_features is not skipped
            - result_pam_authselect_select_profile is not skipped

        - name: Ensure the custom profile changes are applied
          ansible.builtin.command:
            cmd: authselect apply-changes -b --backup=after-rounds-hardening.backup
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
      tags:
        - CCE-83403-6
        - DISA-STIG-RHEL-08-010130
        - accounts_password_pam_unix_rounds_password_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Remediation where authselect tool is not present and PAM files are directly
        edited
      block:

        - name: Ensure the desired rounds value is updated in the custom profile
          ansible.builtin.replace:
            dest: /etc/pam.d/password-auth
            regexp: (^\s*password.*pam_unix.so.*rounds=)(\S+)(.*)$
            replace: \g<1>{{ var_password_pam_unix_rounds }}\g<3>

        - name: Ensure the remember parameter is included in the custom profile
          ansible.builtin.replace:
            dest: /etc/pam.d/password-auth
            regexp: (^\s*password.*pam_unix.so.*)(?! rounds=\S+)(.*)$
            replace: \g<1> \g<2> rounds={{ var_password_pam_unix_rounds }}
          when:
            - result_pam_unix_rounds_present.found == 0
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-83403-6
        - DISA-STIG-RHEL-08-010130
        - accounts_password_pam_unix_rounds_password_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-83386-3
        - DISA-STIG-RHEL-08-010131
        - accounts_password_pam_unix_rounds_system_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check for existing rounds parameter
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        create: false
        regexp: ^password.*pam_unix.so.*rounds=
        state: absent
      check_mode: true
      changed_when: false
      register: result_pam_unix_rounds_present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83386-3
        - DISA-STIG-RHEL-08-010131
        - accounts_password_pam_unix_rounds_system_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Check if system relies on authselect
      ansible.builtin.stat:
        path: /usr/bin/authselect
      register: result_authselect_present
      when: '"pam" in ansible_facts.packages'
      tags:
        - CCE-83386-3
        - DISA-STIG-RHEL-08-010131
        - accounts_password_pam_unix_rounds_system_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Remediation where authselect tool is present
      block:

        - name: Check the integrity of the current authselect profile
          ansible.builtin.command:
            cmd: authselect check
          register: result_authselect_check_cmd
          changed_when: false
          ignore_errors: true

        - name: Informative message based on the authselect integrity check result
          ansible.builtin.assert:
            that:
              - result_authselect_check_cmd is success
            fail_msg:
              - authselect integrity check failed. Remediation aborted!
              - This remediation could not be applied because the authselect profile is
                not intact.
              - It is not recommended to manually edit the PAM files when authselect is
                available.
              - In cases where the default authselect profile does not cover a specific
                demand, a custom authselect profile is recommended.
            success_msg:
              - authselect integrity check passed

        - name: Get authselect current profile
          ansible.builtin.shell:
            cmd: authselect current -r | awk '{ print $1 }'
          register: result_authselect_profile
          changed_when: false
          when:
            - result_authselect_check_cmd is success

        - name: Define the current authselect profile as a local fact
          ansible.builtin.set_fact:
            authselect_current_profile: '{{ result_authselect_profile.stdout }}'
            authselect_custom_profile: '{{ result_authselect_profile.stdout }}'
          when:
            - result_authselect_profile is not skipped
            - result_authselect_profile.stdout is match("custom/")

        - name: Define the new authselect custom profile as a local fact
          ansible.builtin.set_fact:
            authselect_current_profile: '{{ result_authselect_profile.stdout }}'
            authselect_custom_profile: custom/hardening
          when:
            - result_authselect_profile is not skipped
            - result_authselect_profile.stdout is not match("custom/")

        - name: Get authselect current features to also enable them in the custom profile
          ansible.builtin.shell:
            cmd: authselect current | tail -n+3 | awk '{ print $2 }'
          register: result_authselect_features
          changed_when: false
          when:
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")

        - name: Check if any custom profile with the same name was already created in
            the past
          ansible.builtin.stat:
            path: /etc/authselect/{{ authselect_custom_profile }}
          register: result_authselect_custom_profile_present
          changed_when: false
          when:
            - authselect_current_profile is not match("custom/")

        - name: Create a custom profile based on the current profile
          ansible.builtin.command:
            cmd: authselect create-profile hardening -b sssd
          when:
            - result_authselect_check_cmd is success
            - authselect_current_profile is not match("custom/")
            - not result_authselect_custom_profile_present.stat.exists

        - name: Ensure the desired rounds value is updated in the custom profile
          ansible.builtin.replace:
            dest: /etc/authselect/{{ authselect_custom_profile }}/system-auth
            regexp: (^\s*password.*pam_unix.so.*rounds=)(\S+)(.*)$
            replace: \g<1>{{ var_password_pam_unix_rounds }}\g<3>
          when:
            - result_authselect_profile is not skipped
            - result_pam_unix_rounds_present.found == 1

        - name: Ensure the rounds parameter is included in the custom profile
          ansible.builtin.replace:
            dest: /etc/authselect/{{ authselect_custom_profile }}/system-auth
            regexp: (^\s*password.*pam_unix.so.*)(?! rounds=\S+)(.*)$
            replace: \g<1> \g<2> rounds={{ var_password_pam_unix_rounds }}
          when:
            - result_authselect_profile is not skipped
            - result_pam_unix_rounds_present.found == 0

        - name: Ensure a backup of current authselect profile before selecting the custom
            profile
          ansible.builtin.command:
            cmd: authselect apply-changes -b --backup=before-rounds-hardening.backup
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")
            - authselect_custom_profile is not match(authselect_current_profile)

        - name: Ensure the custom profile is selected
          ansible.builtin.command:
            cmd: authselect select {{ authselect_custom_profile }} --force
          register: result_pam_authselect_select_profile
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
            - authselect_current_profile is not match("custom/")
            - authselect_custom_profile is not match(authselect_current_profile)

        - name: Restore the authselect features in the custom profile
          ansible.builtin.command:
            cmd: authselect enable-feature {{ item }}
          loop: '{{ result_authselect_features.stdout_lines }}'
          when:
            - result_authselect_profile is not skipped
            - result_authselect_features is not skipped
            - result_pam_authselect_select_profile is not skipped

        - name: Ensure the custom profile changes are applied
          ansible.builtin.command:
            cmd: authselect apply-changes -b --backup=after-rounds-hardening.backup
          when:
            - result_authselect_check_cmd is success
            - result_authselect_profile is not skipped
      when:
        - '"pam" in ansible_facts.packages'
        - result_authselect_present.stat.exists
      tags:
        - CCE-83386-3
        - DISA-STIG-RHEL-08-010131
        - accounts_password_pam_unix_rounds_system_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Remediation where authselect tool is not present and PAM files are directly
        edited
      block:

        - name: Ensure the desired rounds value is updated in the custom profile
          ansible.builtin.replace:
            dest: /etc/pam.d/system-auth
            regexp: (^\s*password.*pam_unix.so.*rounds=)(\S+)(.*)$
            replace: \g<1>{{ var_password_pam_unix_rounds }}\g<3>

        - name: Ensure the remember parameter is included in the custom profile
          ansible.builtin.replace:
            dest: /etc/pam.d/system-auth
            regexp: (^\s*password.*pam_unix.so.*)(?! rounds=\S+)(.*)$
            replace: \g<1> \g<2> rounds={{ var_password_pam_unix_rounds }}
          when:
            - result_pam_unix_rounds_present.found == 0
      when:
        - '"pam" in ansible_facts.packages'
        - not result_authselect_present.stat.exists
      tags:
        - CCE-83386-3
        - DISA-STIG-RHEL-08-010131
        - accounts_password_pam_unix_rounds_system_auth
        - configure_strategy
        - low_complexity
        - medium_disruption
        - medium_severity
        - no_reboot_needed

    - name: Ensure rsyslog is installed
      package:
        name: rsyslog
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80847-7
        - DISA-STIG-RHEL-08-030670
        - NIST-800-53-CM-6(a)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_rsyslog_installed

    - name: Enable service rsyslog
      block:

        - name: Gather the package facts
          package_facts:
            manager: auto

        - name: Enable service rsyslog
          service:
            name: rsyslog
            enabled: 'yes'
            state: started
            masked: 'no'
          when:
            - '"rsyslog" in ansible_facts.packages'
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80886-5
        - DISA-STIG-RHEL-08-010561
        - NIST-800-53-AU-4(1)
        - NIST-800-53-CM-6(a)
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - service_rsyslog_enabled

    - name: Ensure dhcp-server is removed
      package:
        name: dhcp-server
        state: absent
      tags:
        - CCE-83385-5
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_dhcp_removed

    - name: Ensure sendmail is removed
      package:
        name: sendmail
        state: absent
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-81039-0
        - DISA-STIG-RHEL-08-040002
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_sendmail_removed

    - name: Ensure xinetd is removed
      package:
        name: xinetd
        state: absent
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-80850-1
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - package_xinetd_removed

    - name: Ensure ypbind is removed
      package:
        name: ypbind
        state: absent
      tags:
        - CCE-82181-9
        - disable_strategy
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_ypbind_removed
        - unknown_severity

    - name: Ensure ypserv is removed
      package:
        name: ypserv
        state: absent
      tags:
        - CCE-82432-6
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-5(1)(c)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_ypserv_removed

    - name: Ensure rsh-server is removed
      package:
        name: rsh-server
        state: absent
      tags:
        - CCE-82184-3
        - DISA-STIG-RHEL-08-040010
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - NIST-800-53-IA-5(1)(c)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_rsh-server_removed

    - name: Ensure rsh is removed
      package:
        name: rsh
        state: absent
      tags:
        - CCE-82183-5
        - NIST-800-171-3.1.13
        - disable_strategy
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_rsh_removed
        - unknown_severity

    - name: Ensure talk-server is removed
      package:
        name: talk-server
        state: absent
      tags:
        - CCE-82180-1
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_talk-server_removed

    - name: Ensure talk is removed
      package:
        name: talk
        state: absent
      tags:
        - CCE-80848-5
        - disable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_talk_removed

    - name: Ensure telnet-server is removed
      package:
        name: telnet-server
        state: absent
      tags:
        - CCE-82182-7
        - DISA-STIG-RHEL-08-040000
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_telnet-server_removed

    - name: Ensure telnet is removed
      package:
        name: telnet
        state: absent
      tags:
        - CCE-80849-3
        - NIST-800-171-3.1.13
        - disable_strategy
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - package_telnet_removed

    - name: Ensure tftp-server is removed
      package:
        name: tftp-server
        state: absent
      tags:
        - CCE-82436-7
        - DISA-STIG-RHEL-08-040190
        - NIST-800-53-CM-6(a)
        - NIST-800-53-CM-7(a)
        - NIST-800-53-CM-7(b)
        - disable_strategy
        - high_severity
        - low_complexity
        - low_disruption
        - no_reboot_needed
        - package_tftp-server_removed

    - name: Ensure tftp is removed
      package:
        name: tftp
        state: absent
      tags:
        - CCE-83590-0
        - disable_strategy
        - low_complexity
        - low_disruption
        - low_severity
        - no_reboot_needed
        - package_tftp_removed

